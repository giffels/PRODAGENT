#!/usr/bin/env python
"""
_prodAgent-install-boss-db_

Installation and configuration script for prod agent boss database.

"""

__revision__ = "$Id: prodAgent-install-boss-db,v 1.15 2007/03/04 22:04:15 elmer Exp $"

import getpass
import os
import sys

from ProdAgentCore.Configuration import ProdAgentConfiguration
from ProdAgentDB.Install import adminLogin 
from ProdAgentDB.Install import installDB
from ProdAgentDB.Install import grantUsers
from ProdAgentDB.Install import preInstall

bossPath=os.environ.get('BOSS_ROOT')
if bossPath==None:
   print('BOSSPATH variable is not set')
   sys.exit(1)

path=os.environ.get('PATH')
exists=path.find(bossPath)
if(exists==-1):
   print('BOSSPATH not part of PATH')
   sys.exit(1)

# start the install db process:
valid = ['config=','help']
# check the input
config=preInstall(valid)
# load config file
cfgObject = ProdAgentConfiguration()
cfgObject.loadFromFile(config)
# extract the information
bossDbConfig = cfgObject.get("BOSS")
# part of the boss info we get from the prodagent block:
prodAgentDbConfig = cfgObject.get("ProdAgentDB")

if os.path.isdir(bossDbConfig['configDir']) == 0 :
   os.makedirs(bossDbConfig['configDir'])
if os.path.isdir(bossDbConfig['tmpDir']) == 0 :
   os.makedirs(bossDbConfig['tmpDir'])

# just an idea: this url can be already used!
#bossDbConfig['monaLisaUrl'] = "http://lxgate35.cern.ch:40808/ApMonConf"

print    
print 'Writing BOSS config files in : '+bossDbConfig['configDir']
print    
#overwrite clad files with prod agent defaults.
print
print 'Creating BossConfig.clad'
print

bossConfig=open(bossDbConfig['configDir']+'/BossConfig.clad','w')

bossStr="""
# This is the BOSS configuration file

# *************Generated by ProdAgent*************
[
# BOSS temporary directory (where files are extracted from DB)
BOSS_TMP_DIR = "%s";

# BOSS update interval
BOSS_MIN_UPD_INT = %s;   # at most one update every BOSS_MIN_UPD_INT sec.
BOSS_MAX_UPD_INT = %s;  # at least one update every BOSS_MAX_UPD_INT sec.

# Maximum retries after post-process finishes before killing RTUpdator
# (waits BOSS_UPD_INTERVAL*BOSS_MAX_RETRY seconds)
BOSS_MAX_RETRY = %s;

# Boss Database Backend
DB_BACKEND = "MySQL";

# Info sent also to Monalisa (if empty not enabled)
ML_URL = "%s";
]
""" % (bossDbConfig['tmpDir'],bossDbConfig['minUpdInt'],bossDbConfig['maxUpdInt'],\
    bossDbConfig['maxRetry'],bossDbConfig['monaLisaUrl'])
bossConfig.write(bossStr)
bossConfig.close()

print
print 'Creating MySQLConfig.clad'
print

bossMysql=open(bossDbConfig['configDir']+'/MySQLConfig.clad','w')
bossStr="""

# This is the BOSS MySQL Database configuration file
# *************Generated by ProdAgent*************

[
# BOSS MySQL database file
DB_NAME = "%s";

# Host where the MySQL server is running
DB_HOST = "%s";
DB_DOMAIN = "%s";

# Default BOSS MySQL user and password
DB_USER = "%s";
DB_USER_PW = "%s";

# Guest BOSS MySQL user and password
DB_GUEST = "%s";
DB_GUEST_PW = "%s";

# MySQL table type
TABLE_TYPE = "";

# MySQL port
DB_PORT = %s;

# MySQL socket
DB_SOCKET = "%s";

# MySQL client flag
DB_CLIENT_FLAG = 0;

# MySQL timeout in seconds
DB_CONNECT_TIMEOUT = 30;
]
""" %(prodAgentDbConfig['dbName']+'_BOSS',prodAgentDbConfig['host'],bossDbConfig['domain'],prodAgentDbConfig['user'],prodAgentDbConfig['passwd'],bossDbConfig['guestUser'],bossDbConfig['guestPasswd'],prodAgentDbConfig['portNr'],prodAgentDbConfig['socketFileLocation'])
bossMysql.write(bossStr)
bossMysql.close()


# after modifying the clad files we can generate the schema with the boss
# command.

y=''
try:
   stdin,stdout=os.popen4('bossAdmin configureDB -c ' + bossDbConfig['configDir'])
   lines=stdout.readlines()
   for line in lines:
      if "mysql -u root" in line :
         schemaLocation=line[line.find('MySQL'):]
         break
   y=stdout.read()
   if y!='':
      raise Exception("ERROR",str(y))
except Exception,ex:
   print('*****Ignore this for the moment: '+str(ex[1]))
   print('*****End Ignore')

# once we generate the schema we can install the database
dbName=prodAgentDbConfig['dbName']+'_BOSS'

# ask for password (optional)
userName,passwd=adminLogin()

users={prodAgentDbConfig['user']:prodAgentDbConfig['passwd'],
       bossDbConfig['guestUser']:bossDbConfig['guestPasswd']}

installUser={'userName':userName,
             'passwd':passwd}
# install the database
installDB(schemaLocation,dbName,prodAgentDbConfig['socketFileLocation'],prodAgentDbConfig['portNr'],prodAgentDbConfig['host'],installUser)

schemaLocation='MySQLConfig.sql_grid'
print "schemaLocation for ",dbName,": ",schemaLocation
installDB(schemaLocation,'',prodAgentDbConfig['socketFileLocation'],prodAgentDbConfig['portNr'],prodAgentDbConfig['host'],installUser,False)

# clad files and database have been installed. Register schedulers.
# NOTE: if scheduler install script names change we need to change too.
# NOTE: perhaps put this in the config.xml file?

schedulers=['registerBBSScheduler', 'registerPBSScheduler', \
            'registerCondorScheduler', \
            'registerCONDOR_GScheduler', \
#            'registerLSF-SharedFS-Scheduler', \
            'registerLSF-SharedFS-CERN-Scheduler', \
            'registerEDGScheduler','registerGLITEScheduler', \
            'registerGliteCollectionScheduler', \
#            'registerGliteAPICollectionScheduler', \
            'registerGliteParamScheduler', \
#            'registerGliteAPIParamScheduler', \
            'registerSGEScheduler', \
            'registerForkScheduler']

print
print('Registering schedulers:')
print
y=''
for scheduler in schedulers:
   try:
      if os.path.exists( bossPath + "/BossSched/bin/" + scheduler ) == 0 :
         raise Exception("WARNING", scheduler + " not found. Skipping")
      print('Registering '+scheduler.lstrip('register'))
      cmd = bossPath + '/BossSched/bin/' + scheduler + ' -c ' + bossDbConfig['configDir'] + ' -force'
      stdin,stdout=os.popen4(cmd)
      y=stdout.read()
      if y!='':
         raise Exception("ERROR",str(y))
   except Exception,ex:
      print('ERROR: '+str(ex)+'  '+str(y)+'\Perhaps this user '+\
            'has not the right privileges for boss or the database?')

list=''
try:
   cmd='boss showSchedulers -c ' + bossDbConfig['configDir']
   stdin,stdout=os.popen4(cmd)
   while 1:
       y=stdout.readline()
       if not y:
           stdout.close()
           break
       list+=y
except Exception,ex:
   print('ERROR '+str(ex))


print('The following schedulers where registered:\n'+list)


# register the CMSSW BOSSjobtype

y=''
try:
   if os.path.exists(bossPath+'/Examples/cmsswSchema')==0 :
      raise Exception("WARNING","CMSSW program type not found. Skipping")
   print('Registering cmssw program type')
   cmd = bossPath+'/Examples/registerCMSSWProgram -c ' + bossDbConfig['configDir']
   stdin,stdout=os.popen4(cmd)
   y=stdout.read()
   if y!='':
      raise Exception("ERROR",str(y))
except Exception,ex:
   print('*****Ignore this for the moment: '+str(ex[1]))
   print('*****End Ignore')



y=''
print
print 'Creating MySQLRTConfig.clad'
print

bossConfig=open(bossDbConfig['configDir']+'/MySQLRTConfig.clad','w')

dbName=dbName+'_rt'
bossStr="""
# This is the BOSS MySQL Database configuration file
#***********Generated by prodagent****************
[
# BOSS MySQL database file
DB_NAME = "%s";

# Host where the MySQL server is running
DB_HOST = "%s";
DB_DOMAIN = "%s";

# Default BOSS MySQL user and password
DB_USER = "%s";
DB_USER_PW = "%s";

# Guest BOSS MySQL user and password
DB_GUEST = "%s";
DB_GUEST_PW = "%s";

# MySQL table type
TABLE_TYPE = "";

# MySQL port
DB_PORT = %s;

# MySQL socket
DB_SOCKET = "%s";

# MySQL client flag
DB_CLIENT_FLAG = 0;

# MySQL timeout in seconds
DB_CONNECT_TIMEOUT = 30;
]
""" %(dbName,bossDbConfig['rtHost'],bossDbConfig['rtDomain'],prodAgentDbConfig['user'],prodAgentDbConfig['passwd'],bossDbConfig['guestUser'],bossDbConfig['guestPasswd'],bossDbConfig['rtPortNr'],'')


#write clad file
bossConfig.write(bossStr)
bossConfig.close()

print
print 'Creating ClarensConfig.clad'
print

bossClarens=open(bossDbConfig['configDir']+'/ClarensConfig.clad','w')
bossStr="""
# This is the BOSS Clarens database configuration file
# *************Generated by ProdAgent*************

[
# BOSS Clarens database
DB_NAME = "%s";

# Clarens URL
CLARENS_URL = "%s";

# Clarens CERT
CLARENS_CERT = "%s";

# Clarens KEY
CLARENS_KEY = "%s";

# Clarens PROXY
CLARENS_PROXY = "%s";

# Host where the MySQL server is running
DB_HOST = "%s";
DB_DOMAIN = "%s";

# Default BOSS MySQL user and password
DB_USER = "%s";
DB_USER_PW = "%s";

# Guest BOSS MySQL user and password
DB_GUEST = "%s";
DB_GUEST_PW = "%s";

# MySQL table type
TABLE_TYPE = "";

# MySQL port
DB_PORT = %s;

# MySQL socket
DB_SOCKET = "%s";

# MySQL client flag
DB_CLIENT_FLAG = 0;
]
""" %(dbName,bossDbConfig['clarensUrl'],bossDbConfig['clarensCert'],bossDbConfig['clarensKey'],bossDbConfig['clarensProxy'],prodAgentDbConfig['host'],bossDbConfig['domain'],prodAgentDbConfig['user'],prodAgentDbConfig['passwd'],bossDbConfig['guestUser'],bossDbConfig['guestPasswd'],prodAgentDbConfig['portNr'],prodAgentDbConfig['socketFileLocation'])

bossClarens.write(bossStr)
bossClarens.close()

# register the mysql RTMon

try:
   # as for schedulers...
   cmd = "cd "+bossPath+"/BossRTMon/bin/;bossAdmin registerRTMon -name mysql -updatorPath bossrtupdatorMySQL -default -clientPath bossrtclientMySQL -configPath " + bossDbConfig['configDir']+ "/MySQLRTConfig.clad -c " + bossDbConfig['configDir']
   print cmd
   stdin,stdout=os.popen4(cmd)
   # this is for dealing with questions on replacing
   # the scheduler (this might be easier when the Python API of
   # boss is available
   stdin.write('y')
   stdin.close()
   y=str(stdout.read())
   y=str(stdout.read())
   stdout.close()
   if y!='':
      raise
except Exception,ex:
   print('ERROR: '+str(ex)+'  '+str(y)+'\Perhaps this user '+\
         'has not the right privileges for boss or the database?')
      
# now, set up the configuration, you can register
y=''
try:
   print 'bossAdmin configureRTMonDB -name mysql -c ' + bossDbConfig['configDir']
   stdin,stdout=os.popen4('bossAdmin configureRTMonDB -name mysql -c ' + bossDbConfig['configDir'])
   lines=stdout.readlines()
   for line in lines:
      if "mysql -u root" in line :
         schemaLocation=line[line.find('MySQL'):].strip()
         break
      else :
         schemaLocation=""
   y=stdout.read()
   if y!='':
      raise Exception("ERROR",str(y))
except Exception,ex:
   print('*****Ignore this for the moment: '+str(ex[1]))
   print('*****End Ignore')

# add this to the schema to the database
#schemaLocation='MySQLConfig.sql_1'
if schemaLocation != "":
   print "schemaLocation for ",dbName,": ",schemaLocation

   installDB(schemaLocation,dbName,prodAgentDbConfig['socketFileLocation'],prodAgentDbConfig['portNr'],bossDbConfig['rtHost'],installUser)

   schemaLocation=schemaLocation+'_grid'
   print "schemaLocation for ",dbName,": ",schemaLocation
   installDB(schemaLocation,'',prodAgentDbConfig['socketFileLocation'],prodAgentDbConfig['portNr'],bossDbConfig['rtHost'],installUser,False)


   # we delete the file boss generated
   print('\nDeleting files generated by boss (MySQLConfig.sql*)')
   os.popen('rm MySQLConfig.sql*')


